<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>나만의 여행 동선 미리 보기</title>
    <style>
        .map-title {
          margin: 16px;
        }
        #dateDisplay {
          font-size: 18px;
          margin: 0 10px;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=zMQxurR4vy7qhGFjS5tfO5ZLb8T7vFiV70BvVvtl"></script>
</head>
<body onload="initTmap();">

<h2 class="map-title">나만의 여행 동선 미리 보기</h2>
<div style="margin: 10px;">
    <button onclick="showPrevious()">이전</button>
    <span id="dateDisplay"></span>
    <button onclick="showNext()">다음</button>
</div>
<div id="map_div" style="width: 100%; height: 400px;"></div>

<script>
    let map;
    let routeData = [];
    let currentIndex = 0;
    let markers = [];
    let lines = [];

    function initTmap() {
        map = new Tmapv2.Map("map_div", {
            center: new Tmapv2.LatLng(37.5665, 126.9780),
            width: "100%",
            height: "400px",
            zoom: 12
        });

        window.setRouteData = function(dataString) {
            try {
                console.log("받은 JSON:", dataString);
                const parsed = JSON.parse(dataString);

                routeData = parsed.map(item => ({
                    day: item.day,
                    carLocations: item.Location
                }));
                console.log("파싱된 데이터:", routeData);
                currentIndex = 0;
                drawRouteForDate(currentIndex);
            } catch (e) {
                console.error("setRouteData 오류:", e);
            }
        };
    }

    function drawRouteForDate(index) {
        if (!routeData[index]) return;

        clearMap();

        document.getElementById("dateDisplay").innerText = routeData[index].day;
        const locations = routeData[index].carLocations;

        console.log("현재 인덱스:", index);
        console.log("해당 날짜:", routeData[index].day);
        console.log("경로 데이터:", locations);
        console.log("경로 데이터:", JSON.stringify(locations, null, 2));
        locations.forEach((r, i) => {
              console.log(`▶️ ${i}번 경로`);
              console.log(`from: ${r.fromLat}, ${r.fromLon}`);
              console.log(`to  : ${r.toLat}, ${r.toLon}`);
        });

        if (!locations || locations.length === 0) {
            alert("경로 정보가 없습니다.");
            return;
        }

        const points = [];
        points.push(new Tmapv2.LatLng(locations[0].fromLat, locations[0].fromLon));
        for (let r of locations) {
            points.push(new Tmapv2.LatLng(r.toLat, r.toLon));
        }

        for (let p of points) {
            const marker = new Tmapv2.Marker({
                position: p,
                iconSize: new Tmapv2.Size(24, 38),
                map: map
            });
            markers.push(marker);
        }

        const line = new Tmapv2.Polyline({
            path: points,
            strokeColor: "#FF0000",
            strokeWeight: 6,
            map: map
        });
        lines.push(line);
    }

    function clearMap() {
        markers.forEach(m => m.setMap(null));
        lines.forEach(l => l.setMap(null));
        markers = [];
        lines = [];
    }

    function showNext() {
        if (currentIndex < routeData.length - 1) {
            currentIndex++;
            drawRouteForDate(currentIndex);
        }
    }

    function showPrevious() {
        if (currentIndex > 0) {
            currentIndex--;
            drawRouteForDate(currentIndex);
        }
    }
</script>

</body>
</html>
